<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="002-create-tenants-table" author="riverrun">
        <createTable tableName="tenants">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="code" type="varchar(50)">
                <constraints unique="true"/>
            </column>
            <column name="active" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Insert default tenant -->
        <insert tableName="tenants">
            <column name="id" value="00000000-0000-0000-0000-000000000001"/>
            <column name="name" value="Default Tenant"/>
            <column name="code" value="DEFAULT"/>
            <column name="active" valueBoolean="true"/>
            <column name="description" value="Default tenant for single-tenant deployments"/>
        </insert>
    </changeSet>

    <changeSet id="003-add-tenant-id-to-users" author="riverrun">
        <addColumn tableName="users">
            <column name="tenant_id" type="uuid" defaultValue="00000000-0000-0000-0000-000000000001">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint baseTableName="users" baseColumnNames="tenant_id"
                                 constraintName="fk_users_tenant"
                                 referencedTableName="tenants" referencedColumnNames="id"/>
        <createIndex tableName="users" indexName="idx_users_tenant_id">
            <column name="tenant_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="004-create-form-schemas-table" author="riverrun">
        <createTable tableName="form_schemas">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="schema" type="jsonb">
                <constraints nullable="false"/>
            </column>
            <column name="ui_schema" type="jsonb"/>
            <column name="version" type="varchar(20)" defaultValue="1.0.0">
                <constraints nullable="false"/>
            </column>
            <column name="active" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="uuid"/>
            <column name="updated_by" type="uuid"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="form_schemas" baseColumnNames="tenant_id"
                                 constraintName="fk_form_schemas_tenant"
                                 referencedTableName="tenants" referencedColumnNames="id"/>
        <createIndex tableName="form_schemas" indexName="idx_form_schemas_tenant_id">
            <column name="tenant_id"/>
        </createIndex>
        <createIndex tableName="form_schemas" indexName="idx_form_schemas_code">
            <column name="code"/>
        </createIndex>
    </changeSet>

    <changeSet id="005-create-cases-table" author="riverrun">
        <createTable tableName="cases">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="case_number" type="varchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="case_type" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="status" type="varchar(50)" defaultValue="NEW">
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="varchar(20)"/>
            <column name="assigned_to" type="uuid"/>
            <column name="custom_fields" type="jsonb"/>
            <column name="metadata" type="jsonb"/>
            <column name="due_date" type="timestamp"/>
            <column name="resolved_at" type="timestamp"/>
            <column name="closed_at" type="timestamp"/>
            <column name="created_by" type="uuid"/>
            <column name="updated_by" type="uuid"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="cases" baseColumnNames="tenant_id"
                                 constraintName="fk_cases_tenant"
                                 referencedTableName="tenants" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cases" baseColumnNames="assigned_to"
                                 constraintName="fk_cases_assigned_user"
                                 referencedTableName="users" referencedColumnNames="id"/>
        <createIndex tableName="cases" indexName="idx_cases_tenant_id">
            <column name="tenant_id"/>
        </createIndex>
        <createIndex tableName="cases" indexName="idx_cases_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="cases" indexName="idx_cases_assigned_to">
            <column name="assigned_to"/>
        </createIndex>
    </changeSet>

    <changeSet id="006-create-tasks-table" author="riverrun">
        <createTable tableName="tasks">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="case_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="status" type="varchar(50)" defaultValue="OPEN">
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="varchar(20)"/>
            <column name="assigned_to" type="uuid"/>
            <column name="task_type" type="varchar(100)"/>
            <column name="form_data" type="jsonb"/>
            <column name="due_date" type="timestamp"/>
            <column name="completed_at" type="timestamp"/>
            <column name="created_by" type="uuid"/>
            <column name="updated_by" type="uuid"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="tasks" baseColumnNames="tenant_id"
                                 constraintName="fk_tasks_tenant"
                                 referencedTableName="tenants" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="tasks" baseColumnNames="case_id"
                                 constraintName="fk_tasks_case"
                                 referencedTableName="cases" referencedColumnNames="id"
                                 onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="tasks" baseColumnNames="assigned_to"
                                 constraintName="fk_tasks_assigned_user"
                                 referencedTableName="users" referencedColumnNames="id"/>
        <createIndex tableName="tasks" indexName="idx_tasks_tenant_id">
            <column name="tenant_id"/>
        </createIndex>
        <createIndex tableName="tasks" indexName="idx_tasks_case_id">
            <column name="case_id"/>
        </createIndex>
        <createIndex tableName="tasks" indexName="idx_tasks_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="tasks" indexName="idx_tasks_assigned_to">
            <column name="assigned_to"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
